# ARM64-RTOS CI/CD Pipeline
# Gracemont Industrial Control Framework
# SPDX-License-Identifier: GPL-3.0-or-later

name: ARM64-RTOS CI

on:
  push:
    branches: [main, develop]
    paths:
      - 'ARM64-RTOS/**'
      - '.github/workflows/arm64-rtos.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'ARM64-RTOS/**'
      - '.github/workflows/arm64-rtos.yml'
  workflow_dispatch:

env:
  CROSS_COMPILE: aarch64-elf-

jobs:
  build:
    name: Build ARM64-RTOS
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install ARM64 toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc-aarch64-linux-gnu \
            binutils-aarch64-linux-gnu \
            qemu-system-arm

      - name: Set toolchain prefix
        run: echo "CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV

      - name: Build RTOS
        working-directory: ARM64-RTOS
        run: |
          make clean
          make all CROSS_COMPILE=aarch64-linux-gnu-

      - name: Show build size
        working-directory: ARM64-RTOS
        run: |
          aarch64-linux-gnu-size build/gracemont-rtos.elf

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: arm64-rtos-build
          path: |
            ARM64-RTOS/build/gracemont-rtos.elf
            ARM64-RTOS/build/gracemont-rtos.bin
            ARM64-RTOS/build/gracemont-rtos.hex
            ARM64-RTOS/build/gracemont-rtos.map
          retention-days: 30

  build-tests:
    name: Build with Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install ARM64 toolchain
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            gcc-aarch64-linux-gnu \
            binutils-aarch64-linux-gnu

      - name: Build RTOS with tests
        working-directory: ARM64-RTOS
        run: |
          make clean
          make test CROSS_COMPILE=aarch64-linux-gnu-

      - name: Upload test build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: arm64-rtos-test-build
          path: |
            ARM64-RTOS/build/gracemont-rtos-test.elf
          retention-days: 7

  static-analysis:
    name: Static Analysis
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install analysis tools
        run: |
          sudo apt-get update
          sudo apt-get install -y cppcheck

      - name: Run cppcheck
        working-directory: ARM64-RTOS
        run: |
          cppcheck --enable=warning,style,performance,portability \
            --error-exitcode=1 \
            --suppress=missingIncludeSystem \
            --inline-suppr \
            -I include \
            -I config \
            kernel/ arch/ drivers/ net/ protocols/
        continue-on-error: true

  code-style:
    name: Code Style Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check file headers
        working-directory: ARM64-RTOS
        run: |
          echo "Checking for GPL license headers..."
          find . -name "*.c" -o -name "*.h" | head -20 | while read file; do
            if ! grep -q "SPDX-License-Identifier" "$file" 2>/dev/null; then
              echo "Warning: Missing SPDX header in $file"
            fi
          done
        continue-on-error: true

      - name: Check for trailing whitespace
        working-directory: ARM64-RTOS
        run: |
          ! git grep -l '[[:blank:]]$' -- '*.c' '*.h' '*.S' || echo "Warning: Found trailing whitespace"
        continue-on-error: true

  release:
    name: Create Release Artifacts
    runs-on: ubuntu-latest
    needs: [build, build-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: arm64-rtos-build
          path: release/

      - name: Create release archive
        run: |
          cd release
          tar -czvf gracemont-rtos-${{ github.sha }}.tar.gz *

      - name: Upload release archive
        uses: actions/upload-artifact@v4
        with:
          name: arm64-rtos-release
          path: release/gracemont-rtos-*.tar.gz
          retention-days: 90
